<!DOCTYPE html>
<html>
  <head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<title>Leaflet Quick Start Guide Example</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="bower_components/leaflet-dist/leaflet.css" />
  <link rel="stylesheet" href="bower_components/jquery-ui/themes/smoothness/jquery-ui.css" />

  <script src="bower_components/jquery/dist/jquery.js"></script>
  <script src="bower_components/jquery-ui/jquery-ui.js"></script>
  <script src="bower_components/leaflet-dist/leaflet.js"></script>

  <script src="scripts/api.js"></script>
  <script src="scripts/geolocation.js"></script>

  <style type="text/css">
    @media only screen and (min-width: 991px) {
        #map {width:55%; height:350px; margin:0 auto;}

    }
    @media only screen and (min-width: 768px) and (max-width: 990px) {
        #map {width: 650px; height: 300px;}
    }
    @media only screen and (max-width: 767px) {
      #map {width: 550px; height: 300px;}
    }
  </style>

  </head>

  <body>

	<div class="geo-coords">
        GeoLocation: <span id="Lat">lat: ...</span>°,
               <span id="Long">long: ...</span>°
    </div>
    <!--  The div that is used as the slider container  -->
    <div id="slider" style="margin-top:100px;"></div>

    <!--  The div that is used to display the slider value  -->
    <div><span id="amount" style="color:#777;font-size:72px;text-align:center;"></span>Metros</div>



	 <div id="map" ></div>



  <script>

		// funciona pero no geolocaliza bien con sobremesa y cable.¿?
        var Geo={};

        if (navigator.geolocation) {
           navigator.geolocation.getCurrentPosition(success, error);
        }

        //Get the latitude and the longitude;
        function success(position) {
            Geo.lat = position.coords.latitude;
            Geo.lng = position.coords.longitude;
            populateHeader(Geo.lat, Geo.lng);
            L.marker([Geo.lat, Geo.lng]).addTo(map).bindPopup("You are here").openPopup();
        }

        function error(){
            console.log("Geocoder failed");
        }

        function populateHeader(lat, lng){
            $('#Lat').html(lat);
            $('#Long').html(lng);
        }

  </script>
	<script>

		var map = L.map('map').setView([40.45, -3.70],13);
		L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
		attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://cloudmade.com">CloudMade</a>',
		maxZoom: 18
		}).addTo(map);

    $.getJSON("http://bicimad-api.herokuapp.com/", function (data){
			  // var dar = data;

			  if(data.success == 1) {

          var markers = new L.MarkerClusterGroup();

          $.each( data.estaciones, function( key, val ) {

          var marker = new L.Marker([val.latitud, val.longitud]);
          var aviso = '';

          marker.bindPopup("<b> " + val.nombre + "</b><br/>Total de bicilestas " + val.numero_bases +  "<br/>Libres " + val.libres +  "<br/>Street " + val.direccion + "<br/>" + aviso + "<br>" );
          markers.addLayer(marker);

				});
				map.addLayer(markers);
			  }
		  });

	</script>
  <script>


   // When the browser is ready...
    $(function() {

      // Create a new jQuery UI Slider element
      // and set some default parameters.
      $( "#slider" ).slider({
        orientation: "vertical",
        range: "min",
        value: 0,
        min: 500,
        max: 10000,
        slide: function( event, ui ) {

          // While sliding, update the value in the #amount div element
          $( "#amount" ).html( ui.value );

        },

        change: function(event, ui) {

          $.getJSON("http://bicimad-api.herokuapp.com/api-v1/locations/nearest?lat=" + Geo.lat + "&long=" + Geo.lng + "&distance=" + ui.value,
          function (data){
            console.log(data);

           $.each(data.locations, function( key, val ) {
            console.log(val);
           });


          });



        }
      });

      // Set the initial slider amount in the #amount div element
      var value = $( "#slider" ).slider( "value" );
      $( "#amount" ).html( value );

    });

  </script>

  </body>
</html>
